<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>开始专注</title>
  <style>
    :root{
      --card:#ffffffee;
      --ink:#2d3a3f;
      --muted:#6f7e86;
      --shadow: 0 12px 30px rgba(0,0,0,.18);
      --glass: rgba(255,255,255,.18);
      --glass2: rgba(255,255,255,.10);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family: system-ui, -apple-system, "PingFang SC","Microsoft YaHei", sans-serif; color:var(--ink);}
    body{background:#0b1220; overflow:hidden;}

    /* Scenes */
    .scene{
      position:absolute; inset:0;
      display:none;
      background-size:cover;
      background-position:center;
    }
    .scene.active{display:block;}

    .overlay{
      position:absolute; inset:0;
      background: radial-gradient(ellipse at center, rgba(255,255,255,.06), rgba(0,0,0,.18));
      pointer-events:none;
    }

    /* Setup card */
    .center{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:24px;
    }
    .card{
      width:min(720px, 92vw);
      border-radius: 22px;
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 30px 28px 28px;
      border: 1px solid rgba(255,255,255,.8);
    }
    .title{
      font-size: 30px;
      font-weight: 900;
      text-align:center;
      margin: 2px 0 18px;
      color:#233138;
      letter-spacing:.5px;
    }
    .divider{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(120,140,150,.65), transparent);
      margin: 14px 0 18px;
    }
    .field{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      margin: 14px 0;
    }
    .input{
      width:min(420px, 92%);
      border:0;
      border-bottom: 2px solid rgba(115,135,145,.55);
      background:transparent;
      padding: 8px 8px 10px;
      font-size: 18px;
      text-align:center;
      outline:none;
      color:#2c3b41;
    }
    .input:focus{border-bottom-color: rgba(90,120,130,.9);}
    .minutesWrap{
      display:flex; align-items:center; justify-content:center; gap:10px;
      margin-top: 12px;
      color:#2c3b41;
    }
    .minutes{
      width:86px;
      border:1px solid rgba(140,160,170,.55);
      border-radius: 10px;
      padding: 8px 10px;
      font-size:16px;
      outline:none;
      background: rgba(255,255,255,.65);
      text-align:center;
    }
    .minutes:focus{border-color: rgba(90,120,130,.9);}
    .hint{font-size:14px; color:var(--muted);}

    .startBtn{
      display:flex;
      align-items:center;
      justify-content:center;
      margin: 22px auto 0;
      width: 92px; height: 92px;
      border-radius: 999px;
      border: 0;
      cursor:pointer;
      background: radial-gradient(circle at 35% 30%, #93a9b3, #6f8793 60%, #5d7681);
      box-shadow: 0 18px 30px rgba(0,0,0,.18);
      color:#fff;
      font-weight: 900;
      letter-spacing:.5px;
      text-shadow: 0 2px 10px rgba(0,0,0,.18);
    }
    .startBtn:hover{filter:brightness(1.05)}
    .startBtn:active{transform: translateY(1px)}
    .startBtn span{display:block; line-height:1.05; font-size:14px; text-align:center;}
    .startBtn small{display:block; font-weight:800; font-size:12px; opacity:.95;}

    /* Back button icon */
    .back{
      position:absolute;
      left:10px; top:10px;
      width:32px; height:32px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.14);
      backdrop-filter: blur(8px);
      display:flex; align-items:center; justify-content:center;
      color:#fff;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      z-index:4;
    }
    .back:hover{background: rgba(255,255,255,.22);}
    .back svg{width:18px;height:18px;opacity:.95}

    /* HUD (focus) */
    .hud{
      position:absolute; left:18px; top:16px;
      width:180px;
      padding:10px 10px 12px;
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 14px;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      z-index:3;
    }
    .hud .time{
      font-size:38px;
      letter-spacing:1px;
      font-weight:800;
      color:#fff;
      text-shadow: 0 2px 10px rgba(0,0,0,.25);
      line-height:1;
    }
    .hud .row{display:flex; gap:8px; margin-top:10px;}
    .hud button{
      flex:1;
      border:0;
      padding:7px 8px;
      border-radius: 999px;
      cursor:pointer;
      font-size:12px;
      color:#123;
      background: rgba(255,255,255,.55);
      box-shadow: 0 6px 14px rgba(0,0,0,.12);
    }
    .hud button:hover{background: rgba(255,255,255,.7);}
    .hud .task{
      margin-top:10px;
      font-size:12px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 2px 10px rgba(0,0,0,.25);
    }

    /* Focus video background */
    .bgVideo{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center;
      z-index:0;
    }
    .focusDim{
      position:absolute;
      inset:0;
      background: radial-gradient(ellipse at center, rgba(255,255,255,.04), rgba(0,0,0,.22));
      z-index:1;
      pointer-events:none;
    }

    /* History panel (top-left cumulative) */
    .history{
      position:absolute;
      left:18px;
      top: 16px;
      width: 240px;
      padding: 10px 12px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.30), rgba(255,255,255,.12));
      border: 1px solid rgba(255,255,255,.20);
      border-radius: 14px;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      color: rgba(255,255,255,.95);
      z-index:3;
    }
    .history .hTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:900;
      font-size:13px;
      letter-spacing:.2px;
      text-shadow: 0 2px 10px rgba(0,0,0,.25);
      margin-bottom: 8px;
    }
    .history .hTotal{
      font-weight:800;
      font-size:12px;
      opacity:.92;
      white-space:nowrap;
    }
    .history ul{
      list-style:none;
      padding:0; margin:0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .history li{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.14);
    }
    .history .taskName{
      font-weight:900;
      font-size:12px;
      color: rgba(255,255,255,.95);
      text-shadow: 0 2px 10px rgba(0,0,0,.25);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 150px;
    }
    .history .mins{
      font-weight:900;
      font-size:12px;
      color: rgba(255,255,255,.95);
      text-shadow: 0 2px 10px rgba(0,0,0,.25);
      white-space:nowrap;
    }
    .history .empty{
      font-size:12px;
      opacity:.9;
      padding: 8px 6px;
      background: rgba(255,255,255,.12);
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      line-height:1.35;
    }

    /* Place history in different scenes */
    #setup .history{
      top: 14px;
      left: 14px;
      width: 250px;
    }
    /* Focus: history goes under timer hud to mimic “左上角堆叠信息” */
    #focus .history{
      top: 16px;
      left: 210px; /* 放在计时框右侧，避免遮挡 */
      width: 250px;
    }
    /* End: history stays top-left */
    #end .history{
      top: 16px;
      left: 18px;
      width: 250px;
    }

    /* End scene bubble */
    .bubble{
      position:absolute;
      top: 42px;
      left: 50%;
      transform: translateX(-50%);
      width:min(720px, 92vw);
      padding: 14px 16px;
      border-radius: 14px;
      background: rgba(255,255,255,.80);
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border:1px solid rgba(255,255,255,.9);
      z-index:2;
    }
    .bubble .msg{
      color:#2a3940;
      font-weight:700;
      line-height:1.25;
    }
    .bubble .msg .sub{
      display:block;
      margin-top:4px;
      font-weight:600;
      color:#40545c;
      opacity:.9;
    }
    .bubble .next{
      border:0;
      padding: 10px 14px;
      border-radius: 999px;
      cursor:pointer;
      background: linear-gradient(180deg, #7b93a0, #637c88);
      color:#fff;
      font-weight:900;
      box-shadow: 0 12px 24px rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .bubble .next:hover{filter:brightness(1.05)}

    .endActions{
      position:absolute;
      left: 18px;
      bottom: 20px;
      display:flex;
      gap:12px;
      z-index:2;
    }
    .tagBtn{
      border:0;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.5px;
      padding: 10px 14px;
      border-radius: 10px;
      background: rgba(255,255,255,.78);
      box-shadow: 0 12px 22px rgba(0,0,0,.16);
      color:#2b3b42;
    }
    .tagBtn:hover{background: rgba(255,255,255,.88);}

    /* Tiny toast */
    .toast{
      position:absolute;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(0,0,0,.55);
      color:#fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      opacity:0;
      transition: opacity .25s ease, transform .25s ease;
      pointer-events:none;
      z-index:5;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px);}

    @media (max-width:820px){
      #focus .history{left:18px; top: 164px; width: 230px;}
    }
    @media (max-width:520px){
      .title{font-size:24px;}
      .hud{width:170px}
      .hud .time{font-size:34px;}
      #setup .history, #end .history{width: 220px;}
      #focus .history{width: 210px;}
      .history .taskName{max-width: 120px;}
    }
  </style>
</head>
<body>

  <!-- SETUP -->
  <section id="setup" class="scene active" style="background-image:url('bg-start.webp');">
    <div class="overlay"></div>

    <!-- History (cumulative) -->
    <div class="history" aria-label="历史任务累计">
      <div class="hTitle">
        <span>历史累计</span>
        <span class="hTotal" id="histTotal1">0 分钟</span>
      </div>
      <div id="histList1"></div>
    </div>

    <div class="center">
      <div class="card" role="dialog" aria-label="输入任务和时长">
        <div class="title">现在想要专注什么事呢？</div>
        <div class="divider"></div>

        <div class="field">
          <input id="taskInput" class="input" maxlength="24" placeholder="例如：阅读 / 备课 / 写作" />
        </div>

        <div class="minutesWrap">
          <input id="minutesInput" class="minutes" type="number" min="1" max="180" value="25" />
          <div class="hint">分钟</div>
        </div>

        <button id="startBtn" class="startBtn">
          <span>开始<br><small>专注</small></span>
        </button>
      </div>
    </div>
  </section>

  <!-- FOCUS -->
  <section id="focus" class="scene" style="background-image:none;">
    <video id="focusVideo" class="bgVideo" autoplay loop muted playsinline preload="auto">
      <source src="bg-focus.webm" type="video/webm">
      <source src="bg-focus.mp4" type="video/mp4">
    </video>
    <div class="focusDim"></div>

    <button class="back" id="backBtn" title="返回">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <div class="hud" aria-label="专注计时">
      <div id="timeText" class="time">25:00</div>
      <div class="row">
        <button id="pauseBtn">暂停休息</button>
        <button id="finishBtn">结束任务</button>
      </div>
      <div id="taskText" class="task">当前任务：—</div>
    </div>

    <!-- History (cumulative) -->
    <div class="history" aria-label="历史任务累计">
      <div class="hTitle">
        <span>历史累计</span>
        <span class="hTotal" id="histTotal2">0 分钟</span>
      </div>
      <div id="histList2"></div>
    </div>

    <div class="toast" id="toast"></div>
  </section>

  <!-- END -->
  <section id="end" class="scene" style="background-image:url('bg-end.webp');">
    <button class="back" id="backBtn2" title="返回">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <!-- History (cumulative) -->
    <div class="history" aria-label="历史任务累计">
      <div class="hTitle">
        <span>历史累计</span>
        <span class="hTotal" id="histTotal3">0 分钟</span>
      </div>
      <div id="histList3"></div>
    </div>

    <div class="bubble">
      <div class="msg">
        专注是刺破平庸的针尖
        <span class="sub" id="endSub">此刻的你真好看</span>
      </div>
      <button class="next" id="nextTaskBtn">开始下个任务</button>
    </div>

    <div class="endActions">
      <button class="tagBtn" id="endTaskBtn">任务结束</button>
      <button class="tagBtn" id="breakBtn">进入休息</button>
    </div>

    <div class="toast" id="toast2"></div>
  </section>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const scenes = {
    setup: $("setup"),
    focus: $("focus"),
    end: $("end"),
  };

  const taskInput = $("taskInput");
  const minutesInput = $("minutesInput");
  const startBtn = $("startBtn");

  const timeText = $("timeText");
  const taskText = $("taskText");
  const pauseBtn = $("pauseBtn");
  const finishBtn = $("finishBtn");

  const backBtn = $("backBtn");
  const backBtn2 = $("backBtn2");

  const nextTaskBtn = $("nextTaskBtn");
  const endTaskBtn = $("endTaskBtn");
  const breakBtn = $("breakBtn");

  const endSub = $("endSub");

  const toast = $("toast");
  const toast2 = $("toast2");

  const focusVideo = $("focusVideo");

  const histTotalEls = [ $("histTotal1"), $("histTotal2"), $("histTotal3") ];
  const histListEls  = [ $("histList1"),  $("histList2"),  $("histList3")  ];

  const HISTORY_KEY = "focus_history_v1";

  let timer = null;
  let totalSeconds = 0;
  let remainSeconds = 0;
  let paused = false;
  let currentTask = "";

  function showScene(name){
    Object.values(scenes).forEach(s => s.classList.remove("active"));
    scenes[name].classList.add("active");
    document.title = name === "focus" ? "专注中" : (name === "end" ? "完成" : "开始专注");
    renderHistory(); // 切场景时同步刷新
  }

  function pad(n){ return String(n).padStart(2, "0"); }
  function fmt(sec){
    const m = Math.floor(sec/60);
    const s = sec % 60;
    return `${pad(m)}:${pad(s)}`;
  }

  function toastMsg(el, msg){
    el.textContent = msg;
    el.classList.add("show");
    clearTimeout(el._t);
    el._t = setTimeout(()=> el.classList.remove("show"), 1400);
  }

  function getHistory(){
    try{
      return JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
    }catch(e){
      return [];
    }
  }

  function saveHistory(item){
    try{
      const arr = getHistory();
      arr.unshift(item);
      localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(0, 120))); // 多留一点，累计更有感觉
    }catch(e){}
    renderHistory();
  }

  function normalizeTaskName(s){
    const t = (s || "").trim();
    if(!t) return "未命名";
    return t.length > 24 ? t.slice(0,24) : t;
  }

  function aggregateHistory(){
    const arr = getHistory();
    const map = new Map();
    let total = 0;

    for(const it of arr){
      const task = normalizeTaskName(it.task);
      const mins = Math.max(0, parseInt(it.minutes || 0, 10) || 0);
      if(mins <= 0) continue;
      total += mins;
      map.set(task, (map.get(task) || 0) + mins);
    }

    const items = Array.from(map.entries())
      .map(([task, minutes]) => ({task, minutes}))
      .sort((a,b) => b.minutes - a.minutes);

    return { total, items };
  }

  function renderHistory(){
    const { total, items } = aggregateHistory();
    const top = items.slice(0, 6);

    for(const el of histTotalEls){
      if(el) el.textContent = `${total} 分钟`;
    }

    for(const wrap of histListEls){
      if(!wrap) continue;

      if(top.length === 0){
        wrap.innerHTML = `<div class="empty">还没有累计记录。<br>完成一次专注后，这里会出现你的“专注足迹”。</div>`;
        continue;
      }

      const html = `
        <ul>
          ${top.map(x => `
            <li>
              <span class="taskName">${escapeHtml(x.task)}</span>
              <span class="mins">${x.minutes} 分钟</span>
            </li>
          `).join("")}
        </ul>
      `;
      wrap.innerHTML = html;
    }
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function ensureVideoPlaying(){
    if(!focusVideo) return;
    focusVideo.muted = true;
    const p = focusVideo.play();
    if(p && typeof p.catch === "function") p.catch(()=>{});
  }

  function startFocus(){
    const task = normalizeTaskName(taskInput.value) || "阅读";
    const mins = Math.max(1, Math.min(180, parseInt(minutesInput.value || "25", 10)));

    currentTask = task;
    totalSeconds = mins * 60;
    remainSeconds = totalSeconds;
    paused = false;

    taskText.textContent = `当前任务：${currentTask}`;
    pauseBtn.textContent = "暂停休息";
    timeText.textContent = fmt(remainSeconds);

    showScene("focus");
    ensureVideoPlaying();

    if(timer) clearInterval(timer);
    timer = setInterval(()=>{
      if(paused) return;
      remainSeconds = Math.max(0, remainSeconds - 1);
      timeText.textContent = fmt(remainSeconds);
      if(remainSeconds <= 0){
        clearInterval(timer);
        timer = null;
        onFinish(true);
      }
    }, 1000);
  }

  function togglePause(){
    paused = !paused;
    pauseBtn.textContent = paused ? "继续专注" : "暂停休息";

    if(focusVideo){
      if(paused) focusVideo.pause();
      else ensureVideoPlaying();
    }

    toastMsg(toast, paused ? "已暂停" : "继续啦");
  }

  function onFinish(natural=false){
    if(timer) clearInterval(timer);
    timer = null;

    if(focusVideo) focusVideo.pause();

    const spent = totalSeconds - remainSeconds;
    const spentMin = Math.max(1, Math.round(spent / 60));

    endSub.textContent = natural
      ? `你完成了「${currentTask}」｜${spentMin} 分钟`
      : `你先停在这里也可以｜已专注 ${spentMin} 分钟`;

    // 写入历史（用于累计）
    saveHistory({
      task: currentTask,
      minutes: spentMin,
      at: new Date().toISOString()
    });

    showScene("end");
  }

  function backToSetup(){
    if(timer) clearInterval(timer);
    timer = null;
    paused = false;

    if(focusVideo) focusVideo.pause();

    showScene("setup");
    toastMsg(toast2, "回到开始页");
  }

  function startBreak(){
    taskInput.value = "休息";
    minutesInput.value = "5";
    showScene("setup");
    toastMsg(toast2, "进入休息：5 分钟");
  }

  // events
  startBtn.addEventListener("click", startFocus);
  minutesInput.addEventListener("keydown", (e) => { if(e.key === "Enter") startFocus(); });
  taskInput.addEventListener("keydown", (e) => { if(e.key === "Enter") startFocus(); });

  pauseBtn.addEventListener("click", togglePause);
  finishBtn.addEventListener("click", () => onFinish(false));

  backBtn.addEventListener("click", backToSetup);
  backBtn2.addEventListener("click", backToSetup);

  nextTaskBtn.addEventListener("click", () => {
    taskInput.value = "";
    minutesInput.value = "25";
    showScene("setup");
    toastMsg(toast2, "开始下一个吧");
  });

  endTaskBtn.addEventListener("click", () => {
    toastMsg(toast2, "已记录本次专注");
    renderHistory();
  });

  breakBtn.addEventListener("click", startBreak);

  // defaults
  taskInput.value = "阅读";
  minutesInput.value = "25";

  // initial render
  renderHistory();
})();
</script>
</body>
</html>
