<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>开始专注</title>
  <style>
    :root{
      --card:#ffffffee;
      --ink:#2d3a3f;
      --muted:#6f7e86;
      --shadow: 0 12px 30px rgba(0,0,0,.18);
      --glass: rgba(255,255,255,.18);
      --glass2: rgba(255,255,255,.10);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family: system-ui, -apple-system, "PingFang SC","Microsoft YaHei", sans-serif; color:var(--ink);}
    body{background:#0b1220; overflow:hidden;}

    /* Scenes */
    .scene{
      position:absolute; inset:0;
      display:none;
      background-size:cover;
      background-position:center;
    }
    .scene.active{display:block;}

    .overlay{
      position:absolute; inset:0;
      background: radial-gradient(ellipse at center, rgba(255,255,255,.06), rgba(0,0,0,.18));
      pointer-events:none;
    }

    /* Setup card */
    .center{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:24px;
    }
    .card{
      width:min(720px, 92vw);
      border-radius: 22px;
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 30px 28px 28px;
      border: 1px solid rgba(255,255,255,.8);
    }
    .title{
      font-size: 30px;
      font-weight: 900;
      text-align:center;
      margin: 2px 0 18px;
      color:#233138;
      letter-spacing:.5px;
    }
    .divider{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(120,140,150,.65), transparent);
      margin: 14px 0 18px;
    }
    .field{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      margin: 14px 0;
    }
    .input{
      width:min(460px, 92%);
      border:0;
      border-bottom: 2px solid rgba(115,135,145,.55);
      background:transparent;
      padding: 8px 8px 10px;
      font-size: 18px;
      text-align:center;
      outline:none;
      color:#2c3b41;
    }
    .input:focus{border-bottom-color: rgba(90,120,130,.9);}
    .minutesWrap{
      display:flex; align-items:center; justify-content:center; gap:10px;
      margin-top: 12px;
      color:#2c3b41;
    }
    .minutes{
      width:86px;
      border:1px solid rgba(140,160,170,.55);
      border-radius: 10px;
      padding: 8px 10px;
      font-size:16px;
      outline:none;
      background: rgba(255,255,255,.65);
      text-align:center;
    }
    .minutes:focus{border-color: rgba(90,120,130,.9);}
    .hint{font-size:14px; color:var(--muted);}

    .startBtn{
      display:flex;
      align-items:center;
      justify-content:center;
      margin: 22px auto 0;
      width: 92px; height: 92px;
      border-radius: 999px;
      border: 0;
      cursor:pointer;
      background: radial-gradient(circle at 35% 30%, #93a9b3, #6f8793 60%, #5d7681);
      box-shadow: 0 18px 30px rgba(0,0,0,.18);
      color:#fff;
      font-weight: 900;
      letter-spacing:.5px;
      text-shadow: 0 2px 10px rgba(0,0,0,.18);
    }
    .startBtn:hover{filter:brightness(1.05)}
    .startBtn:active{transform: translateY(1px)}
    .startBtn span{display:block; line-height:1.05; font-size:14px; text-align:center;}
    .startBtn small{display:block; font-weight:800; font-size:12px; opacity:.95;}

    /* Back button */
    .back{
      position:absolute;
      left:10px; top:10px;
      width:32px; height:32px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.14);
      backdrop-filter: blur(8px);
      display:flex; align-items:center; justify-content:center;
      color:#fff;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      z-index:4;
    }
    .back:hover{background: rgba(255,255,255,.22);}
    .back svg{width:18px;height:18px;opacity:.95}

    /* HUD (focus) */
    .hud{
      position:absolute; left:18px; top:16px;
      width:180px;
      padding:10px 10px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,.10));
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 14px;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      z-index:3;
    }
    .hud .time{
      font-size:38px;
      letter-spacing:1px;
      font-weight:800;
      color:#fff;
      text-shadow: 0 2px 10px rgba(0,0,0,.25);
      line-height:1;
    }
    .hud .row{display:flex; gap:8px; margin-top:10px;}
    .hud button{
      flex:1;
      border:0;
      padding:7px 8px;
      border-radius: 999px;
      cursor:pointer;
      font-size:12px;
      color:#123;
      background: rgba(255,255,255,.55);
      box-shadow: 0 6px 14px rgba(0,0,0,.12);
    }
    .hud button:hover{background: rgba(255,255,255,.7);}
    .hud .task{
      margin-top:10px;
      font-size:12px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 2px 10px rgba(0,0,0,.25);
    }

    /* Focus video background */
    .bgVideo{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center;
      z-index:0;
    }
    .focusDim{
      position:absolute;
      inset:0;
      background: radial-gradient(ellipse at center, rgba(255,255,255,.04), rgba(0,0,0,.22));
      z-index:1;
      pointer-events:none;
    }

    /* History panel */
    .history{
      position:absolute;
      left:18px;
      top: 16px;
      width: 250px;
      padding: 10px 12px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.30), rgba(255,255,255,.12));
      border: 1px solid rgba(255,255,255,.20);
      border-radius: 14px;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      color: rgba(255,255,255,.95);
      z-index:3;
    }
    .history .hTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:900;
      font-size:13px;
      letter-spacing:.2px;
      text-shadow: 0 2px 10px rgba(0,0,0,.25);
      margin-bottom: 8px;
    }
    .history .hTotal{
      font-weight:800;
      font-size:12px;
      opacity:.92;
      white-space:nowrap;
    }
    .history ul{
      list-style:none;
      padding:0; margin:0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .history li{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.14);
    }
    .history .taskName{
      font-weight:900;
      font-size:12px;
      color: rgba(255,255,255,.95);
      text-shadow: 0 2px 10px rgba(0,0,0,.25);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 150px;
    }
    .history .mins{
      font-weight:900;
      font-size:12px;
      color: rgba(255,255,255,.95);
      text-shadow: 0 2px 10px rgba(0,0,0,.25);
      white-space:nowrap;
    }
    .history .empty{
      font-size:12px;
      opacity:.9;
      padding: 8px 6px;
      background: rgba(255,255,255,.12);
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      line-height:1.35;
    }

    /* Layout per scene */
    #setup .history{left:14px; top:14px;}
    #focus .history{left:210px; top:16px;} /* 放计时框右侧 */
    #end .history{left:18px; top:16px;}

    /* End scene bubble */
    .bubble{
      position:absolute;
      top: 42px;
      left: 50%;
      transform: translateX(-50%);
      width:min(720px, 92vw);
      padding: 14px 16px;
      border-radius: 14px;
      background: rgba(255,255,255,.80);
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border:1px solid rgba(255,255,255,.9);
      z-index:2;
    }
    .bubble .msg{
      color:#2a3940;
      font-weight:700;
      line-height:1.25;
    }
    .bubble .msg .sub{
      display:block;
      margin-top:4px;
      font-weight:600;
      color:#40545c;
      opacity:.9;
    }
    .bubble .next{
      border:0;
      padding: 10px 14px;
      border-radius: 999px;
      cursor:pointer;
      background: linear-gradient(180deg, #7b93a0, #637c88);
      color:#fff;
      font-weight:900;
      box-shadow: 0 12px 24px rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .bubble .next:hover{filter:brightness(1.05)}

    .endActions{
      position:absolute;
      left: 18px;
      bottom: 20px;
      display:flex;
      gap:12px;
      z-index:2;
    }
    .tagBtn{
      border:0;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.5px;
      padding: 10px 14px;
      border-radius: 10px;
      background: rgba(255,255,255,.78);
      box-shadow: 0 12px 22px rgba(0,0,0,.16);
      color:#2b3b42;
    }
    .tagBtn:hover{background: rgba(255,255,255,.88);}

    /* Toast */
    .toast{
      position:absolute;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(0,0,0,.55);
      color:#fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      opacity:0;
      transition: opacity .25s ease, transform .25s ease;
      pointer-events:none;
      z-index:6;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px);}

    @media (max-width:820px){
      #focus .history{left:18px; top: 164px; width: 230px;}
      .history .taskName{max-width: 120px;}
    }
    @media (max-width:520px){
      .title{font-size:24px;}
      .hud{width:170px}
      .hud .time{font-size:34px;}
      #setup .history, #end .history{width: 220px;}
      #focus .history{width: 210px;}
    }
  </style>
</head>
<body>

  <!-- SETUP -->
  <section id="setup" class="scene active" style="background-image:url('bg-start.webp');">
    <div class="overlay"></div>

    <div class="history" aria-label="历史任务累计">
      <div class="hTitle">
        <span id="histTitle1">历史累计</span>
        <span class="hTotal" id="histTotal1">0 分钟</span>
      </div>
      <div id="histList1"></div>
    </div>

    <div class="center">
      <div class="card" role="dialog" aria-label="输入用户名、任务和时长">
        <div class="title">现在想要专注什么事呢？</div>
        <div class="divider"></div>

        <div class="field">
          <input id="userInput" class="input" maxlength="16" placeholder="用户名（例如：谢老师 / 小轩 / 大轩）" />
        </div>

        <div class="field">
          <input id="taskInput" class="input" maxlength="24" placeholder="任务（例如：阅读 / 备课 / 写作）" />
        </div>

        <div class="minutesWrap">
          <input id="minutesInput" class="minutes" type="number" min="1" max="180" value="25" />
          <div class="hint">分钟</div>
        </div>

        <button id="startBtn" class="startBtn">
          <span>开始<br><small>专注</small></span>
        </button>
      </div>
    </div>

    <div class="toast" id="toastSetup"></div>
  </section>

  <!-- FOCUS -->
  <section id="focus" class="scene" style="background-image:none;">
    <video id="focusVideo" class="bgVideo" autoplay loop muted playsinline preload="metadata">
      <source src="bg-focus.webm" type="video/webm">
      <source src="bg-focus.mp4" type="video/mp4">
    </video>
    <div class="focusDim"></div>

    <button class="back" id="backBtn" title="返回">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <div class="hud" aria-label="专注计时">
      <div id="timeText" class="time">25:00</div>
      <div class="row">
        <button id="pauseBtn">暂停休息</button>
        <button id="finishBtn">结束任务</button>
      </div>
      <div id="taskText" class="task">当前任务：—</div>
    </div>

    <div class="history" aria-label="历史任务累计">
      <div class="hTitle">
        <span id="histTitle2">历史累计</span>
        <span class="hTotal" id="histTotal2">0 分钟</span>
      </div>
      <div id="histList2"></div>
    </div>

    <div class="toast" id="toastFocus"></div>
  </section>

  <!-- END -->
  <section id="end" class="scene" style="background-image:url('bg-end.webp');">
    <button class="back" id="backBtn2" title="返回">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <div class="history" aria-label="历史任务累计">
      <div class="hTitle">
        <span id="histTitle3">历史累计</span>
        <span class="hTotal" id="histTotal3">0 分钟</span>
      </div>
      <div id="histList3"></div>
    </div>

    <div class="bubble">
      <div class="msg">
        专注是刺破平庸的针尖
        <span class="sub" id="endSub">此刻的你真好看</span>
      </div>
      <button class="next" id="nextTaskBtn">开始下个任务</button>
    </div>

    <div class="endActions">
      <button class="tagBtn" id="endTaskBtn">任务结束</button>
      <button class="tagBtn" id="breakBtn">进入休息</button>
    </div>

    <div class="toast" id="toastEnd"></div>
  </section>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const scenes = { setup: $("setup"), focus: $("focus"), end: $("end") };

  const userInput    = $("userInput");
  const taskInput    = $("taskInput");
  const minutesInput = $("minutesInput");
  const startBtn     = $("startBtn");

  const timeText   = $("timeText");
  const taskText   = $("taskText");
  const pauseBtn   = $("pauseBtn");
  const finishBtn  = $("finishBtn");

  const backBtn  = $("backBtn");
  const backBtn2 = $("backBtn2");

  const nextTaskBtn = $("nextTaskBtn");
  const endTaskBtn  = $("endTaskBtn");
  const breakBtn    = $("breakBtn");

  const endSub = $("endSub");

  const toastSetup = $("toastSetup");
  const toastFocus = $("toastFocus");
  const toastEnd   = $("toastEnd");

  const focusVideo = $("focusVideo");

  const histTitleEls = [ $("histTitle1"), $("histTitle2"), $("histTitle3") ];
  const histTotalEls = [ $("histTotal1"), $("histTotal2"), $("histTotal3") ];
  const histListEls  = [ $("histList1"),  $("histList2"),  $("histList3")  ];

  // ===== 用户分桶存储 =====
  const USER_KEY = "focus_current_user_v1";
  const HISTORY_PREFIX = "focus_history_v1__";

  let currentUser = "";
  let timer = null;
  let totalSeconds = 0;
  let remainSeconds = 0;
  let endAtMs = 0;     // 预计结束时间戳（毫秒）
  let pauseAtMs = 0;   // 暂停开始时间戳（毫秒）
  let paused = false;
  let currentTask = "";
  let audioCtx = null;

  function normalizeUserName(s){
    const t = (s || "").trim();
    if(!t) return "";
    return t.replace(/\s+/g, " ").slice(0,16);
  }
  function normalizeTaskName(s){
    const t = (s || "").trim();
    if(!t) return "未命名";
    return t.length > 24 ? t.slice(0,24) : t;
  }
  function historyKeyFor(user){
    return HISTORY_PREFIX + encodeURIComponent(user);
  }
  function getHistory(){
    if(!currentUser) return [];
    try{
      return JSON.parse(localStorage.getItem(historyKeyFor(currentUser)) || "[]");
    }catch(e){
      return [];
    }
  }
  function saveHistory(item){
    if(!currentUser) return;
    try{
      const arr = getHistory();
      arr.unshift(item);
      localStorage.setItem(historyKeyFor(currentUser), JSON.stringify(arr.slice(0, 120)));
    }catch(e){}
    renderHistory();
  }

  function pad(n){ return String(n).padStart(2, "0"); }
  function fmt(sec){
    const m = Math.floor(sec/60);
    const s = sec % 60;
    return `${pad(m)}:${pad(s)}`;
  }

  function toastMsg(el, msg){
    if(!el) return;
    el.textContent = msg;
    el.classList.add("show");
    clearTimeout(el._t);
    el._t = setTimeout(()=> el.classList.remove("show"), 1400);
  }

  function setTitle(sceneName){
    const u = currentUser || normalizeUserName(userInput?.value) || "未命名";
    document.title =
      sceneName === "focus" ? `${u}｜专注中` :
      sceneName === "end"   ? `${u}｜完成` :
                              `${u}｜开始专注`;
  }

  function showScene(name){
    Object.values(scenes).forEach(s => s.classList.remove("active"));
    scenes[name].classList.add("active");
    setTitle(name);
    renderHistory();
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function aggregateHistory(){
    const arr = getHistory();
    const map = new Map();
    let total = 0;

    for(const it of arr){
      const task = normalizeTaskName(it.task);
      const mins = Math.max(0, parseInt(it.minutes || 0, 10) || 0);
      if(mins <= 0) continue;
      total += mins;
      map.set(task, (map.get(task) || 0) + mins);
    }

    const items = Array.from(map.entries())
      .map(([task, minutes]) => ({task, minutes}))
      .sort((a,b) => b.minutes - a.minutes);

    return { total, items };
  }

  function renderHistory(){
    const u = currentUser || normalizeUserName(userInput?.value) || "";
    const title = u ? `历史累计｜${u}` : "历史累计";

    for(const el of histTitleEls){
      if(el) el.textContent = title;
    }

    // 未填写用户时，展示提示
    if(!u){
      for(const el of histTotalEls){
        if(el) el.textContent = `0 分钟`;
      }
      for(const wrap of histListEls){
        if(!wrap) continue;
        wrap.innerHTML = `<div class="empty">先填写用户名，再开始专注。<br>不同用户名会各自累计自己的记录。</div>`;
      }
      return;
    }

    // 已有用户
    const { total, items } = aggregateHistory();
    const top = items.slice(0, 6);

    for(const el of histTotalEls){
      if(el) el.textContent = `${total} 分钟`;
    }

    for(const wrap of histListEls){
      if(!wrap) continue;
      if(top.length === 0){
        wrap.innerHTML = `<div class="empty">还没有累计记录。<br>完成一次专注后，这里会出现你的专注足迹。</div>`;
        continue;
      }
      wrap.innerHTML = `
        <ul>
          ${top.map(x => `
            <li>
              <span class="taskName">${escapeHtml(x.task)}</span>
              <span class="mins">${x.minutes} 分钟</span>
            </li>
          `).join("")}
        </ul>
      `;
    }
  }

  function ensureVideoPlaying(){
    if(!focusVideo) return;
    focusVideo.muted = true;
    const p = focusVideo.play();
    if(p && typeof p.catch === "function") p.catch(()=>{});
  }

function initAudioIfNeeded(){
  // 必须在用户点击“开始专注”等手势之后调用，才能保证后续后台也能响
  try{
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(audioCtx.state === "suspended"){
      audioCtx.resume();
    }
  }catch(e){}
}

function playCheerfulChime(){
    // 约 3 秒的“庆祝成功”提示音：明亮、带一点回声、结尾落在大三和弦
    if(!audioCtx) return;
    try{
      if(audioCtx.state === "suspended"){
        audioCtx.resume();
      }

      const now = audioCtx.currentTime;

      // 主输出 + 轻微回声（让它更“有存在感”）
      const out = audioCtx.createGain();
      out.gain.setValueAtTime(0.0001, now);
      out.gain.exponentialRampToValueAtTime(0.50, now + 0.02);   // 峰值音量（不刺耳但明显）
      out.gain.exponentialRampToValueAtTime(0.0001, now + 3.05); // 总时长 ~3s
      out.connect(audioCtx.destination);

      const delay = audioCtx.createDelay(0.25);
      delay.delayTime.setValueAtTime(0.12, now);
      const fb = audioCtx.createGain();
      fb.gain.setValueAtTime(0.22, now);
      delay.connect(fb);
      fb.connect(delay);

      const echoMix = audioCtx.createGain();
      echoMix.gain.setValueAtTime(0.35, now);
      delay.connect(echoMix);
      echoMix.connect(audioCtx.destination);

      // 统一的“音符播放器”（每个音符独立包络，避免拖泥带水）
      function playNote(freq, t, dur, type, gain){
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type;
        o.frequency.setValueAtTime(freq, t);

        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(gain, t + 0.015);
        g.gain.exponentialRampToValueAtTime(0.0001, t + dur);

        o.connect(g);
        g.connect(out);
        g.connect(delay);

        o.start(t);
        o.stop(t + dur + 0.02);
      }

      // 小“亮片”噪声：像庆祝时的闪一下（很轻）
      function sparkle(t){
        const bufLen = Math.floor(audioCtx.sampleRate * 0.06);
        const buf = audioCtx.createBuffer(1, bufLen, audioCtx.sampleRate);
        const data = buf.getChannelData(0);
        for(let i=0;i<bufLen;i++){
          data[i] = (Math.random() * 2 - 1) * 0.6;
        }
        const src = audioCtx.createBufferSource();
        src.buffer = buf;

        const bp = audioCtx.createBiquadFilter();
        bp.type = "bandpass";
        bp.frequency.setValueAtTime(5200, t);
        bp.Q.setValueAtTime(10, t);

        const g = audioCtx.createGain();
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.12, t + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t + 0.06);

        src.connect(bp);
        bp.connect(g);
        g.connect(out);
        g.connect(delay);

        src.start(t);
        src.stop(t + 0.07);
      }

      // ===== 旋律（C 大调的“成功音”感觉）=====
      // 节奏：前半段快、后半段落稳
      const seq = [
        // 频率, 开始偏移, 时长
        [523.25, 0.00, 0.16], // C5
        [659.25, 0.16, 0.16], // E5
        [783.99, 0.32, 0.16], // G5
        [1046.50,0.48, 0.18], // C6

        [783.99, 0.72, 0.14], // G5
        [987.77, 0.86, 0.16], // B5
        [1174.66,1.02, 0.20], // D6

        // “胜利落点”：C 大三和弦（C6 + E6 + G6）短促后再延音
        [1046.50,1.35, 0.22], // C6
        [1318.51,1.35, 0.22], // E6
        [1567.98,1.35, 0.22], // G6

        [1046.50,1.72, 0.90], // C6 延音（收束）
        [1318.51,1.72, 0.90], // E6
        [1567.98,1.72, 0.90], // G6
      ];

      // 亮一点的主音色 + 轻一点的低一层，保证听得见又不刺
      for(const [f, off, d] of seq){
        playNote(f, now + off, d, "triangle", 0.22);
        playNote(f/2, now + off, d, "sine", 0.09);
      }

      // 在关键点加一点“闪光”
      sparkle(now + 0.02);
      sparkle(now + 1.38);
      sparkle(now + 1.75);

    }catch(e){}
}

  function startFocus(){
    const u = normalizeUserName(userInput.value);
    if(!u){
      toastMsg(toastSetup, "先写用户名，方便多人累计统计");
      showScene("setup");
      return;
    }
    currentUser = u;
    localStorage.setItem(USER_KEY, currentUser);

    initAudioIfNeeded();

    const task = normalizeTaskName(taskInput.value || "阅读");
    const mins = Math.max(1, Math.min(180, parseInt(minutesInput.value || "25", 10)));

    currentTask = task;
    totalSeconds = mins * 60;
    remainSeconds = totalSeconds;
    paused = false;

    // 用真实时间驱动（避免后台标签页 setInterval 被降频导致计时不准）
    endAtMs = Date.now() + totalSeconds * 1000;
    pauseAtMs = 0;

    taskText.textContent = `当前任务：${currentTask}`;
    pauseBtn.textContent = "暂停休息";
    timeText.textContent = fmt(remainSeconds);

    showScene("focus");
    ensureVideoPlaying();

    if(timer) clearInterval(timer);
    timer = setInterval(()=>{
      if(paused) return;

      const remain = Math.ceil((endAtMs - Date.now()) / 1000);
      remainSeconds = Math.max(0, remain);
      timeText.textContent = fmt(remainSeconds);

      if(remainSeconds <= 0){
        clearInterval(timer);
        timer = null;
        onFinish(true);
      }
    }, 250);
  }

  function togglePause(){
    // 先用当前时间校正一下剩余秒数
    const remain = Math.ceil((endAtMs - Date.now()) / 1000);
    remainSeconds = Math.max(0, remain);
    timeText.textContent = fmt(remainSeconds);

    paused = !paused;
    pauseBtn.textContent = paused ? "继续专注" : "暂停休息";

    if(paused){
      pauseAtMs = Date.now();
      if(focusVideo) focusVideo.pause();
      toastMsg(toastFocus, "已暂停");
    }else{
      const pausedDur = Date.now() - (pauseAtMs || Date.now());
      endAtMs += pausedDur; // 把暂停的时间加回结束时间
      pauseAtMs = 0;
      if(focusVideo) ensureVideoPlaying();
      toastMsg(toastFocus, "继续啦");
    }
  }

  function onFinish(natural=false){
    // 结束前先用真实时间校正一次，避免后台降频导致的误差
    if(!paused && endAtMs){
      const remain = Math.ceil((endAtMs - Date.now()) / 1000);
      remainSeconds = Math.max(0, remain);
    }

    if(timer) clearInterval(timer);
    timer = null;
    endAtMs = 0;
    pauseAtMs = 0;

    if(focusVideo) focusVideo.pause();

    const spent = totalSeconds - remainSeconds;
    const spentMin = Math.max(1, Math.round(spent / 60));

    endSub.textContent = natural
      ? `你完成了「${currentTask}」｜${spentMin} 分钟`
      : `你先停在这里也可以｜已专注 ${spentMin} 分钟`;

    saveHistory({
      task: currentTask,
      minutes: spentMin,
      at: new Date().toISOString()
    });

    playCheerfulChime();

    showScene("end");
  }

  function backToSetup(){
    if(timer) clearInterval(timer);
    timer = null;
    paused = false;
    endAtMs = 0;
    pauseAtMs = 0;

    if(focusVideo) focusVideo.pause();

    showScene("setup");
    toastMsg(toastSetup, "回到开始页");
  }

  function startBreak(){
    taskInput.value = "休息";
    minutesInput.value = "5";
    showScene("setup");
    toastMsg(toastSetup, "进入休息：5 分钟");
  }

  // events
  startBtn.addEventListener("click", startFocus);
  minutesInput.addEventListener("keydown", (e) => { if(e.key === "Enter") startFocus(); });
  taskInput.addEventListener("keydown", (e) => { if(e.key === "Enter") startFocus(); });
  userInput.addEventListener("input", () => {
    const u = normalizeUserName(userInput.value);
    // 不强行切换 currentUser，避免输入时误切；只是刷新面板显示
    if(!currentUser && u) renderHistory();
    setTitle(scenes.focus.classList.contains("active") ? "focus" : (scenes.end.classList.contains("active") ? "end" : "setup"));
  });

  pauseBtn.addEventListener("click", togglePause);
  finishBtn.addEventListener("click", () => onFinish(false));

  backBtn.addEventListener("click", backToSetup);
  backBtn2.addEventListener("click", backToSetup);

  nextTaskBtn.addEventListener("click", () => {
    taskInput.value = "";
    minutesInput.value = "25";
    showScene("setup");
    toastMsg(toastSetup, "开始下一个吧");
  });

  endTaskBtn.addEventListener("click", () => {
    toastMsg(toastEnd, "已记录本次专注");
    renderHistory();
  });

  breakBtn.addEventListener("click", startBreak);

  // defaults + restore last user
  currentUser = normalizeUserName(localStorage.getItem(USER_KEY) || "");
  if(currentUser) userInput.value = currentUser;

  taskInput.value = "阅读";
  minutesInput.value = "25";

  showScene("setup");
})();
</script>
</body>
</html>
